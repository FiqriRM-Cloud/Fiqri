<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WarKas - Sistem Kasir</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#1976d2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icons/Warkas192.png">
    <style>
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        /* Add this new style */
        .container {
            margin-top: 60px; /* Add top margin to prevent overlap */
        }
    </style>
</head>
<body class="bg-light">
    <a href="dashboard.html" class="btn btn-secondary mt-3">
        <i class="fas fa-arrow-left me-2"></i>Kembali ke Dashboard
    </a>

    <div class="container py-5">
        <div class="row">
            <!-- Form Tambah Produk -->
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-plus-circle me-2"></i>Tambah Produk</h5>
                    </div>
                    <div class="card-body">
                        <form id="form-tambah">
                            <div class="mb-3">
                                <label for="nama" class="form-label">Nama Produk</label>
                                <input type="text" class="form-control" id="nama" required>
                            </div>
                            <div class="mb-3">
                                <label for="harga" class="form-label">Harga</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="number" class="form-control" id="harga" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="stok" class="form-label">Stok</label>
                                <input type="number" class="form-control" id="stok" required>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="tambahProduk()">
                                <i class="fas fa-save me-2"></i>Simpan Produk
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Tabel Produk -->
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-box me-2"></i>Daftar Produk</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama Produk</th>
                                        <th>Harga</th>
                                        <th>Stok</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="daftar-produk">
                                    <!-- Data produk akan ditampilkan di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        const request = indexedDB.open("WarKasDB", 1);

        request.onerror = (event) => {
            console.error("Database error: " + event.target.error);
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            muatProduk();
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains("produk")) {
                const store = db.createObjectStore("produk", { keyPath: "id" });
                store.createIndex("nama", "nama", { unique: true });
            }
        };

        function tambahProduk() {
            const nama = document.getElementById("nama").value.trim();
            const harga = parseInt(document.getElementById("harga").value);
            const stok = parseInt(document.getElementById("stok").value);

            if (!nama || isNaN(harga) || isNaN(stok) || harga <= 0 || stok < 0) {
                showAlert('warning', 'Mohon isi semua kolom dengan benar!');
                return;
            }

            if (!db) {
                showAlert('error', 'Database belum siap. Mohon tunggu sebentar.');
                return;
            }

            // Cek apakah produk sudah ada
            const tx = db.transaction("produk", "readwrite");
            const store = tx.objectStore("produk");
            const getReq = store.index("nama").get(nama);

            getReq.onsuccess = () => {
                let produk = getReq.result;
                if (produk) {
                    // Produk sudah ada, tambahkan batch baru
                    produk.batches.push({ qty: stok, harga: harga });
                    store.put(produk);
                } else {
                    // Produk baru
                    produk = {
                        id: Date.now(),
                        nama: nama,
                        batches: [{ qty: stok, harga: harga }]
                    };
                    store.add(produk);
                }
                showAlert('success', 'Produk berhasil ditambahkan!');
                document.getElementById("form-tambah").reset();
                muatProduk();
            };

            getReq.onerror = () => {
                showAlert('error', 'Gagal mengambil data produk!');
            };
        }

        function muatProduk() {
            const tbody = document.getElementById("daftar-produk");
            tbody.innerHTML = '';

            const tx = db.transaction("produk", "readonly");
            const store = tx.objectStore("produk");
            const request = store.getAll();

            request.onsuccess = () => {
                const produkList = request.result;
                produkList.forEach((item, index) => {
                    // Hitung total stok dan harga batch terakhir
                    const totalStok = item.batches.reduce((sum, b) => sum + b.qty, 0);
                    const hargaTerbaru = item.batches.length > 0 ? item.batches[item.batches.length - 1].harga : 0;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.nama}</td>
                        <td>Rp ${hargaTerbaru.toLocaleString('id-ID')}</td>
                        <td>${totalStok}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editProduk(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="hapusProduk(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            };
        }

        function editProduk(id) {
            const tx = db.transaction("produk", "readonly");
            const store = tx.objectStore("produk");
            const request = store.get(id);

            request.onsuccess = () => {
                const produk = request.result;
                // Tampilkan batch terakhir di form
                const lastBatch = produk.batches[produk.batches.length - 1];
                document.getElementById("nama").value = produk.nama;
                document.getElementById("harga").value = lastBatch.harga;
                document.getElementById("stok").value = lastBatch.qty;

                // Change save button to update mode
                const saveBtn = document.querySelector("#form-tambah button");
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Produk';
                saveBtn.onclick = () => updateProduk(id);
            };
        }

        function updateProduk(id) {
            const nama = document.getElementById("nama").value.trim();
            const harga = parseInt(document.getElementById("harga").value);
            const stok = parseInt(document.getElementById("stok").value);

            if (!nama || isNaN(harga) || isNaN(stok) || harga <= 0 || stok < 0) {
                showAlert('warning', 'Mohon isi semua kolom dengan benar!');
                return;
            }

            const tx = db.transaction("produk", "readwrite");
            const store = tx.objectStore("produk");
            const request = store.get(id);

            request.onsuccess = () => {
                const produk = request.result;
                // Tambahkan batch baru
                produk.batches.push({ qty: stok, harga: harga });
                store.put(produk);

                showAlert('success', 'Produk berhasil diupdate!');
                document.getElementById("form-tambah").reset();

                // Reset button to add mode
                const saveBtn = document.querySelector("#form-tambah button");
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Simpan Produk';
                saveBtn.onclick = tambahProduk;

                muatProduk();
            };

            request.onerror = () => {
                showAlert('error', 'Gagal mengupdate produk!');
            };
        }

        function hapusProduk(id) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                const tx = db.transaction("produk", "readwrite");
                const store = tx.objectStore("produk");
                const request = store.delete(id);

                request.onsuccess = () => {
                    showAlert('success', 'Produk berhasil dihapus!');
                    muatProduk();
                };

                request.onerror = () => {
                    showAlert('error', 'Gagal menghapus produk!');
                };
            }
        }

        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'warning' ? 'alert-warning' : 'alert-danger';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Konten halaman -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
<script src="produk.js"></script>
</body>
</html>

